<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Frequently Asked Questions · ModelingToolkit.jl</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-90474609-3"></script><script>  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-90474609-3', {'page_path': location.pathname + location.search + location.hash});
</script><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://docs.sciml.ai/ModelingToolkit/stable/basics/FAQ/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="ModelingToolkit.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">ModelingToolkit.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../tutorials/ode_modeling/">Getting Started with ModelingToolkit.jl</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../../tutorials/acausal_components/">Acausal Component-Based Modeling</a></li><li><a class="tocitem" href="../../tutorials/nonlinear/">Modeling Nonlinear Systems</a></li><li><a class="tocitem" href="../../tutorials/optimization/">Modeling Optimization Problems</a></li><li><a class="tocitem" href="../../tutorials/modelingtoolkitize/">Modelingtoolkitize: Automatically Translating Numerical to Symbolic Code</a></li><li><a class="tocitem" href="../../tutorials/stochastic_diffeq/">Modeling with Stochasticity</a></li><li><a class="tocitem" href="../../tutorials/parameter_identifiability/">Parameter Identifiability in ODE Models</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><input class="collapse-toggle" id="menuitem-4-1" type="checkbox"/><label class="tocitem" for="menuitem-4-1"><span class="docs-label">Basic Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../examples/higher_order/">Automatic Transformation of Nth Order ODEs to 1st Order ODEs</a></li><li><a class="tocitem" href="../../examples/spring_mass/">Component-Based Modeling of a Spring-Mass System</a></li><li><a class="tocitem" href="../../examples/modelingtoolkitize_index_reduction/">Automated Index Reduction of DAEs</a></li><li><a class="tocitem" href="../../examples/parsing/">Parsing Expressions into Solvable Systems</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2" type="checkbox"/><label class="tocitem" for="menuitem-4-2"><span class="docs-label">Advanced Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../examples/tearing_parallelism/">Exposing More Parallelism By Tearing Algebraic Equations in ODESystems</a></li><li><a class="tocitem" href="../../examples/sparse_jacobians/">Automated Sparse Analytical Jacobians</a></li><li><a class="tocitem" href="../../examples/perturbation/">Symbolic-Numeric Perturbation Theory for ODEs</a></li></ul></li></ul></li><li><span class="tocitem">Basics</span><ul><li><a class="tocitem" href="../AbstractSystem/">The AbstractSystem Interface</a></li><li><a class="tocitem" href="../ContextualVariables/">Contextual Variable Types</a></li><li><a class="tocitem" href="../Variable_metadata/">Symbolic metadata</a></li><li><a class="tocitem" href="../Composition/">Composing Models and Building Reusable Components</a></li><li><a class="tocitem" href="../Events/">Event Handling and Callback Functions</a></li><li><a class="tocitem" href="../Linearization/">Linearization</a></li><li><a class="tocitem" href="../Validation/">Model Validation and Units</a></li><li><a class="tocitem" href="../DependencyGraphs/">Dependency Graphs</a></li><li class="is-active"><a class="tocitem" href>Frequently Asked Questions</a><ul class="internal"><li><a class="tocitem" href="#Getting-the-index-for-a-symbol"><span>Getting the index for a symbol</span></a></li><li><a class="tocitem" href="#Transforming-value-maps-to-arrays"><span>Transforming value maps to arrays</span></a></li><li><a class="tocitem" href="#How-do-I-handle-if-statements-in-my-symbolic-forms?"><span>How do I handle <code>if</code> statements in my symbolic forms?</span></a></li><li><a class="tocitem" href="#ERROR:-TypeError:-non-boolean-(Num)-used-in-boolean-context?"><span>ERROR: TypeError: non-boolean (Num) used in boolean context?</span></a></li><li><a class="tocitem" href="#Using-ModelingToolkit-with-Optimization-/-Automatic-Differentiation"><span>Using ModelingToolkit with Optimization / Automatic Differentiation</span></a></li></ul></li></ul></li><li><span class="tocitem">System Types</span><ul><li><a class="tocitem" href="../../systems/ODESystem/">ODESystem</a></li><li><a class="tocitem" href="../../systems/SDESystem/">SDESystem</a></li><li><a class="tocitem" href="../../systems/JumpSystem/">JumpSystem</a></li><li><a class="tocitem" href="../../systems/NonlinearSystem/">NonlinearSystem</a></li><li><a class="tocitem" href="../../systems/OptimizationSystem/">OptimizationSystem</a></li><li><a class="tocitem" href="../../systems/DiscreteSystem/">DiscreteSystem</a></li><li><a class="tocitem" href="../../systems/PDESystem/">PDESystem</a></li></ul></li><li><a class="tocitem" href="../../comparison/">Comparison of ModelingToolkit vs Equation-Based and Block Modeling Languages</a></li><li><a class="tocitem" href="../../internals/">Internal Details</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Basics</a></li><li class="is-active"><a href>Frequently Asked Questions</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Frequently Asked Questions</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/SciML/ModelingToolkit.jl/blob/master/docs/src/basics/FAQ.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Frequently-Asked-Questions"><a class="docs-heading-anchor" href="#Frequently-Asked-Questions">Frequently Asked Questions</a><a id="Frequently-Asked-Questions-1"></a><a class="docs-heading-anchor-permalink" href="#Frequently-Asked-Questions" title="Permalink"></a></h1><h2 id="Getting-the-index-for-a-symbol"><a class="docs-heading-anchor" href="#Getting-the-index-for-a-symbol">Getting the index for a symbol</a><a id="Getting-the-index-for-a-symbol-1"></a><a class="docs-heading-anchor-permalink" href="#Getting-the-index-for-a-symbol" title="Permalink"></a></h2><p>Since <strong>ordering of symbols is not guaranteed after symbolic transformations</strong>, one should normally refer to values by their name. For example, <code>sol[lorenz.x]</code> from the solution. But what if you need to get the index? The following helper function will do the trick:</p><pre><code class="language-julia hljs">indexof(sym, syms) = findfirst(isequal(sym), syms)
indexof(σ, parameters(sys))</code></pre><h2 id="Transforming-value-maps-to-arrays"><a class="docs-heading-anchor" href="#Transforming-value-maps-to-arrays">Transforming value maps to arrays</a><a id="Transforming-value-maps-to-arrays-1"></a><a class="docs-heading-anchor-permalink" href="#Transforming-value-maps-to-arrays" title="Permalink"></a></h2><p>ModelingToolkit.jl allows (and recommends) input maps like <code>[x =&gt; 2.0, y =&gt; 3.0]</code> because symbol ordering is not guaranteed. However, what if you want to get the lowered array? You can use the internal function <code>varmap_to_vars</code>. For example:</p><pre><code class="language-julia hljs">pnew = varmap_to_vars([β =&gt; 3.0, c =&gt; 10.0, γ =&gt; 2.0], parameters(sys))</code></pre><h2 id="How-do-I-handle-if-statements-in-my-symbolic-forms?"><a class="docs-heading-anchor" href="#How-do-I-handle-if-statements-in-my-symbolic-forms?">How do I handle <code>if</code> statements in my symbolic forms?</a><a id="How-do-I-handle-if-statements-in-my-symbolic-forms?-1"></a><a class="docs-heading-anchor-permalink" href="#How-do-I-handle-if-statements-in-my-symbolic-forms?" title="Permalink"></a></h2><p>For statements that are in the <code>if then else</code> form, use <code>IfElse.ifelse</code> from the <a href="https://github.com/SciML/IfElse.jl">IfElse.jl</a> package to represent the code in a functional form. For handling direct <code>if</code> statements, you can use equivalent boolean mathematical expressions. For example, <code>if x &gt; 0 ...</code> can be implemented as just <code>(x &gt; 0) *</code>, where if <code>x &lt;= 0</code> then the boolean will evaluate to <code>0</code> and thus the term will be excluded from the model.</p><h2 id="ERROR:-TypeError:-non-boolean-(Num)-used-in-boolean-context?"><a class="docs-heading-anchor" href="#ERROR:-TypeError:-non-boolean-(Num)-used-in-boolean-context?">ERROR: TypeError: non-boolean (Num) used in boolean context?</a><a id="ERROR:-TypeError:-non-boolean-(Num)-used-in-boolean-context?-1"></a><a class="docs-heading-anchor-permalink" href="#ERROR:-TypeError:-non-boolean-(Num)-used-in-boolean-context?" title="Permalink"></a></h2><p>If you see the error:</p><pre><code class="nohighlight hljs">ERROR: TypeError: non-boolean (Num) used in boolean context</code></pre><p>then it&#39;s likely you are trying to trace through a function which cannot be directly represented in Julia symbols. The techniques to handle this problem, such as <code>@register_symbolic</code>, are described in detail <a href="https://symbolics.juliasymbolics.org/dev/manual/faq/#Transforming-my-function-to-a-symbolic-equation-has-failed.-What-do-I-do?-1">in the Symbolics.jl documentation</a>.</p><h2 id="Using-ModelingToolkit-with-Optimization-/-Automatic-Differentiation"><a class="docs-heading-anchor" href="#Using-ModelingToolkit-with-Optimization-/-Automatic-Differentiation">Using ModelingToolkit with Optimization / Automatic Differentiation</a><a id="Using-ModelingToolkit-with-Optimization-/-Automatic-Differentiation-1"></a><a class="docs-heading-anchor-permalink" href="#Using-ModelingToolkit-with-Optimization-/-Automatic-Differentiation" title="Permalink"></a></h2><p>If you are using ModelingToolkit inside a loss function and are having issues with mixing MTK with automatic differentiation, getting performance, etc… don&#39;t! Instead, use MTK outside the loss function to generate the code, and then use the generated code inside the loss function.</p><p>For example, let&#39;s say you were building ODEProblems in the loss function like:</p><pre><code class="language-julia hljs">function loss(p)
    prob = ODEProblem(sys, [], [p1 =&gt; p[1], p2 =&gt; p[2]])
    sol = solve(prob, Tsit5())
    sum(abs2, sol)
end</code></pre><p>Since <code>ODEProblem</code> on a MTK <code>sys</code> will have to generate code, this will be slower than caching the generated code, and will require automatic differentiation to go through the code generation process itself. All of this is unnecessary. Instead, generate the problem once outside the loss function, and remake the prob inside the loss function:</p><pre><code class="language-julia hljs">prob = ODEProblem(sys, [], [p1 =&gt; p[1], p2 =&gt; p[2]])
function loss(p)
    remake(prob, p = ...)
    sol = solve(prob, Tsit5())
    sum(abs2, sol)
end</code></pre><p>Now, one has to be careful with <code>remake</code> to ensure that the parameters are in the right order. One can use the previously mentioned indexing functionality to generate index maps for reordering <code>p</code> like:</p><pre><code class="language-julia hljs">p = @parameters x y z
idxs = ModelingToolkit.varmap_to_vars([p[1] =&gt; 1, p[2] =&gt; 2, p[3] =&gt; 3], p)
p[idxs]</code></pre><p>Using this, the fixed index map can be used in the loss function. This would look like:</p><pre><code class="language-julia hljs">prob = ODEProblem(sys, [], [p1 =&gt; p[1], p2 =&gt; p[2]])
idxs = Int.(ModelingToolkit.varmap_to_vars([p1 =&gt; 1, p2 =&gt; 2], p))
function loss(p)
    remake(prob, p = p[idxs])
    sol = solve(prob, Tsit5())
    sum(abs2, sol)
end</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../DependencyGraphs/">« Dependency Graphs</a><a class="docs-footer-nextpage" href="../../systems/ODESystem/">ODESystem »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.24 on <span class="colophon-date" title="Friday 28 April 2023 22:26">Friday 28 April 2023</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
